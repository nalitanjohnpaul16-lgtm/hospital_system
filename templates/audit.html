{% extends 'layout.html' %}
{% block content %}
<div class="bg-full" style="background-image:url('/assets/ZZZZZZZZZZZZZZZZ.jpg')"></div>
<div class="content-wrap">
  <h2 class="glass-title">Audit Events</h2>

  <div class="audit-toolbar">
    <div class="audit-toolbar-left">
      {% if current_user and current_user.role and current_user.role|lower in ['admin','auditor','it_security'] %}
      <form method="post" action="{{ url_for('audit_archive') }}">
        <button type="submit" class="btn danger">Archive Current Logs</button>
      </form>
      <a href="{{ url_for('audit_archive_view') }}" class="btn secondary">View Archive</a>
      {% endif %}
      {% if current_user and current_user.role and current_user.role|lower in ['admin','auditor'] %}
      <form method="post" action="{{ url_for('audit_new_session') }}"
        onsubmit="return confirm('Start a new audit session? Current logs will be archived and a fresh audit session will begin.');">
        <button type="submit" class="btn primary">Start New Audit Session</button>
      </form>
      {% endif %}
      <form method="get" action="{{ url_for('audit_index') }}" style="display:flex; align-items:center; gap:8px;">
        <label for="kind" style="opacity:.8;">Filter:</label>
        <select id="kind" name="kind" class="input"
          onchange="this.form.action = this.value ? ('/audit/' + this.value) : '/audit'; this.form.submit();">
          <option value="" {% if not filter_kind %}selected{% endif %}>All</option>
          {% for k in kinds %}
          <option value="{{ k }}" {% if filter_kind==k %}selected{% endif %}>{{ k }}</option>
          {% endfor %}
        </select>
      </form>
    </div>

    <div class="audit-toolbar-right">
      <div class="search-container">
        <input type="text" id="auditSearchInput" placeholder="Search audit logs..." class="search-input">
        <button type="button" id="auditClearSearch" class="clear-search" title="Clear search">Ã—</button>
      </div>
    </div>
  </div>

  {% if events %}
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Kind</th>
          <th>Action</th>
          <th>User</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for e in events %}
        <tr>
          <td>{{ e.timestamp }}</td>
          <td>{{ e.kind }}</td>
          <td>{{ e.action }}</td>
          <td>{{ e.username }}</td>
          <td>
            <div class="audit-details-box" title="{{ e.details | tojson }}">{{ e.details | tojson }}</div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p>No audit events yet.</p>
  {% endif %}
</div>

<style>
  /* Audit toolbar layout */
  .audit-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 10px;
  }

  .audit-toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .audit-toolbar-right {
    display: flex;
    align-items: center;
  }

  /* Search container */
  .search-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-input {
    padding: 8px 35px 8px 12px;
    border: 2px solid #4a90e2;
    border-radius: 6px;
    font-size: 14px;
    width: 250px;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: #357abd;
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
    background: white;
  }

  .clear-search {
    position: absolute;
    right: 8px;
    background: none;
    border: none;
    font-size: 18px;
    color: #666;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .clear-search:hover {
    background: #f0f0f0;
    color: #333;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .audit-toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .audit-toolbar-left,
    .audit-toolbar-right {
      justify-content: center;
    }

    .search-input {
      width: 100%;
      max-width: 300px;
    }
  }

  /* Highlight matching text */
  .highlight-match {
    background-color: yellow;
    font-weight: bold;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('auditSearchInput');
    const clearButton = document.getElementById('auditClearSearch');
    const table = document.querySelector('.table tbody');
    const rows = table ? Array.from(table.querySelectorAll('tr')) : [];

    // Store original row content for restoration
    const originalRowContent = rows.map(row => row.innerHTML);

    function performSearch() {
      const searchTerm = searchInput.value.toLowerCase().trim();

      if (!searchTerm) {
        // Show all rows and restore original content
        rows.forEach((row, index) => {
          row.style.display = '';
          row.innerHTML = originalRowContent[index];
        });
        return;
      }

      rows.forEach((row, index) => {
        // Restore original content first
        row.innerHTML = originalRowContent[index];

        const cells = row.querySelectorAll('td');
        let hasMatch = false;

        cells.forEach(cell => {
          const cellText = cell.textContent.toLowerCase();
          if (cellText.includes(searchTerm)) {
            hasMatch = true;
            // Highlight matching text
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            cell.innerHTML = cell.innerHTML.replace(regex, '<span class="highlight-match">$1</span>');
          }
        });

        // Show/hide row based on match
        row.style.display = hasMatch ? '' : 'none';
      });
    }

    function clearSearch() {
      searchInput.value = '';
      performSearch();
      searchInput.focus();
    }

    // Event listeners
    if (searchInput) {
      searchInput.addEventListener('input', performSearch);
      searchInput.addEventListener('keyup', function (e) {
        if (e.key === 'Escape') {
          clearSearch();
        }
      });
    }

    if (clearButton) {
      clearButton.addEventListener('click', clearSearch);
    }

    // Show/hide clear button based on input content
    if (searchInput && clearButton) {
      function toggleClearButton() {
        clearButton.style.display = searchInput.value ? 'flex' : 'none';
      }

      searchInput.addEventListener('input', toggleClearButton);
      toggleClearButton(); // Initial state
    }
  });
</script>

{% endblock %}